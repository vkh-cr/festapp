-- Consolidated migration to fix database security warnings
-- Replaces:
-- 20260218120000_fix_mutable_search_paths.sql
-- 20260218130000_fix_remaining_mutable_search_paths.sql
-- 20260218140000_fix_final_mutable_search_paths.sql

-- 1. Drop legacy overload of confirm_blueprint_order_change (Procedure)
DROP PROCEDURE IF EXISTS public.confirm_blueprint_order_change(IN p_spot_ids bigint[], IN p_email text, IN p_project_url text, INOUT p_result jsonb);

-- 2. Fix overly permissive RLS policies
-- Restrict 'Allow service role full access' policies to service_role only
ALTER POLICY "Allow service role full access" ON public.external_occasions_cache TO service_role;
ALTER POLICY "Allow service role full access" ON public.external_sync_maps TO service_role;
ALTER POLICY "Allow service role full access" ON public.external_sync_sources TO service_role;

-- 3. Move dblink extension to extensions schema
CREATE SCHEMA IF NOT EXISTS extensions;
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'dblink' AND extnamespace = 'public'::regnamespace) THEN
        ALTER EXTENSION dblink SET SCHEMA extensions;
    END IF;
EXCEPTION WHEN OTHERS THEN
    RAISE NOTICE 'Could not move dblink extension: %', SQLERRM;
END $$;

-- 4. Fix mutable search_path for all affected functions

-- Batch 1
ALTER FUNCTION eshop._swap_spot_tickets(spot_id_1 bigint, spot_id_2 bigint) SET search_path = eshop, public, extensions;
ALTER FUNCTION eshop._swap_spots_generate_product_json(p_product_id bigint, p_spot_id bigint) SET search_path = eshop, public, extensions;
ALTER FUNCTION eshop.add_transaction_to_payment_info(p_transaction_id bigint, p_payment_info_id bigint) SET search_path = eshop, public, extensions;
ALTER FUNCTION eshop.get_bank_account_by_import_token(p_token uuid) SET search_path = eshop, public, extensions;
ALTER FUNCTION eshop.get_tickets_with_details(ticket_ids bigint[]) SET search_path = eshop, public, extensions;
ALTER FUNCTION eshop.process_email_transaction(p_bank_account_id bigint, p_external_id text, p_amount numeric, p_currency text, p_counterparty_account text, p_variable_symbol text, p_message text, p_date timestamp with time zone, p_raw_email text, p_transaction_id bigint) SET search_path = eshop, public, extensions;
ALTER FUNCTION eshop.swap_spot_tickets(spot_id_1 bigint, spot_id_2 bigint) SET search_path = eshop, public, extensions;
ALTER FUNCTION eshop.swap_spots_update_ticket(p_opt_id bigint, p_new_product_id bigint, p_new_spot_id bigint) SET search_path = eshop, public, extensions;
ALTER FUNCTION public._swap_spot_tickets(spot_id_1 bigint, spot_id_2 bigint) SET search_path = public, extensions;
ALTER FUNCTION public._swap_spots_generate_product_json(p_product_id bigint, p_spot_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.add_sent_to_customer_flag(history_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.add_sync_map(p_source_name text, p_target_org_id bigint, p_target_unit_id bigint, p_remote_link_base text, p_remote_org_id bigint, p_remote_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.add_transaction_to_payment_info(p_transaction_id bigint, payment_info_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.add_user_to_occasion(oc bigint, usr uuid) SET search_path = public, extensions;
ALTER FUNCTION public.add_user_to_unit(unit_id bigint, usr uuid) SET search_path = public, extensions;
ALTER FUNCTION public.adjust_spot_capacity_for_pool(p_inventory_pool_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.apply_allocations(p_order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.assign_spot_to_resource(p_spot_id bigint, p_inventory_context_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_access_to_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_admin_for_bank_account(bank_acc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_editor_via_form_link(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.confirm_blueprint_order_change(p_spot_ids bigint[], p_input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.create_companion_in_organization(org bigint, oc bigint, usr uuid, c_name text) SET search_path = public, extensions;
ALTER FUNCTION public.create_form(p_occasion_id bigint, p_link text, p_title text) SET search_path = public, extensions;
ALTER FUNCTION public.create_form_ws(input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.create_service_item(oc bigint, type text, code text, title text, reference bigint) SET search_path = public, extensions;
ALTER FUNCTION public.create_ticket_order(input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.create_ticket_ordert(input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.create_unit_and_assign_manager(title text) SET search_path = public, extensions;
ALTER FUNCTION public.create_user(oc bigint, email text, password text) SET search_path = public, extensions;
ALTER FUNCTION public.create_user_in_organization_with_data_pure(org bigint, email text, password text, data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.create_user_in_organization_with_data_ws(org bigint, email text, password text, data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.create_user_with_data(oc bigint, email text, password text, data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.delete_autosave_history(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_form(p_form_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_form_ws(p_form_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_inclusion_type_group(p_inclusion_type_group_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_inventory_pool(p_inventory_pool_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_manual_transaction_ws(p_transaction_id bigint, p_payment_info_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_occasion_email_template(p_occasion_id bigint, p_code text) SET search_path = public, extensions;
ALTER FUNCTION public.delete_order_221(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_order_history(p_history_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_resource(p_resource_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_unit_user(usr uuid, unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.duplicate_form(p_old_form_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.duplicate_form(p_old_form_id bigint, p_new_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.duplicate_form_to_occasion(source_form_id bigint, target_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.duplicate_form_to_occasion(source_form_id bigint, target_occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.duplicate_form_ws(p_form_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.duplicate_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.game_guess(check_point_id bigint, guess text) SET search_path = public, extensions;
ALTER FUNCTION public.generate_request_secret(p_ttl_seconds integer) SET search_path = public, extensions;
ALTER FUNCTION public.generate_schema_rls_enable_ddl(p_schema text) SET search_path = public, extensions;
ALTER FUNCTION public.generate_schema_triggers_ddl(p_schema text) SET search_path = public, extensions;
ALTER FUNCTION public.generate_variable_symbol(bank_account_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_activities_for_edit(p_occasion bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_activity_history_version(p_history_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_email_templates(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_email_templates(p_context jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_email_templates_via_form_link(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_forms_with_fields(occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_occasions(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_occasions_for_edit(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_occasions_for_edit_v212(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_user_basics_for_scan(scan_code text) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_user_basics_from_occasion_unit(p_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_user_group_info(p_occasion_id bigint, p_type text) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_users_from_unit(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_viewable_forms_for_copying() SET search_path = public, extensions;
ALTER FUNCTION public.get_app_config(data_in jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_app_config_v182(data_in jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_app_config_v203(data_in jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_app_config_v216(data_in jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_app_config_v218(data_in jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_bank_account_by_import_token(p_token text) SET search_path = public, extensions;
ALTER FUNCTION public.get_bank_account_users(p_bank_account_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_bank_account_users(p_bank_account_id bigint, p_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_bank_accounts_for_unit_management(p_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_blueprint_for_edit(occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_current_organization_data() SET search_path = public, extensions;
ALTER FUNCTION public.get_email_template_and_wrapper(p_code text) SET search_path = public, extensions;
ALTER FUNCTION public.get_email_template_and_wrapper(p_code text, p_context jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_exists_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_exists_on_occasion_user(usr uuid, oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_external_services(p_order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_fetchable_bank_accounts() SET search_path = public, extensions;
ALTER FUNCTION public.get_fetchable_bank_accounts_for_unit(p_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_fetchable_bank_accounts_with_t_count() SET search_path = public, extensions;
ALTER FUNCTION public.get_form_from_link_for_edit(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_form_from_linkt(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_forms_for_occasion_or_unit(occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_inventory_pool_bundle(p_inventory_pool_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_admin_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_approved_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_approver_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_editor_order_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_event_allowed(ev bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_manager_on_any_occasion() SET search_path = public, extensions;
ALTER FUNCTION public.get_is_manager_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_latest_autosave(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_my_admin_bank_accounts() SET search_path = public, extensions;
ALTER FUNCTION public.get_my_events_and_activities(p_occasion bigint, p_include_description boolean) SET search_path = public, extensions;
ALTER FUNCTION public.get_occasion_by_link(link_param text) SET search_path = public, extensions;
ALTER FUNCTION public.get_occasion_by_scan_code(scan_code text) SET search_path = public, extensions;
ALTER FUNCTION public.get_occasion_from_link(org_id bigint, link_txt text) SET search_path = public, extensions;
ALTER FUNCTION public.get_order(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_order_details_for_email(p_order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_order_with_form(p_order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_orders(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_orders(form_key uuid) SET search_path = public, extensions;
ALTER FUNCTION public.get_orders(p_occasion_link text, p_form_link text, p_options jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_orders_tab_data(p_occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_products_and_types(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_products_and_types_for_occasion(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_reply_to_email_for_order(p_order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_reservations(occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_reservations(p_occasion_link text, p_form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_spot_management_bundle(p_inventory_pool_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_tickets_with_details(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_tickets_with_details(ticket_ids bigint[]) SET search_path = public, extensions;
ALTER FUNCTION public.get_transactions_for_order_all_available(payment_info_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_user_companions(event_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_user_companions_data() SET search_path = public, extensions;
ALTER FUNCTION public.get_user_companions_data(event_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_user_group_info_with_users(p_group_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_user_groups(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_user_id_by_email(email text) SET search_path = public, extensions;
ALTER FUNCTION public.get_user_inventory() SET search_path = public, extensions;
ALTER FUNCTION public.get_users_from_occasion_with_orders(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.import_users_from_tickets_ws(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.insert_transactions(transactions jsonb, bank_account_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.is_claims_admin() SET search_path = public, extensions;
ALTER FUNCTION public.is_product_dynamically_available(p_product_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.process_email_transaction(p_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.process_email_transaction(p_bank_account_id bigint, p_external_id text, p_amount numeric, p_currency text, p_counterparty_account text, p_variable_symbol text, p_constant_symbol text, p_specific_symbol text, p_message text, p_date timestamp with time zone, p_raw_email text, p_transaction_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.process_occasion_auto_import(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.regenerate_bank_account_pairing_code(p_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.remove_from_queue_emails(task_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.remove_transaction_from_payment_info_ws(p_transaction_id bigint, p_payment_info_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.reset_all_sequences() SET search_path = public, extensions;
ALTER FUNCTION public.reset_user_password(p_user_id uuid, p_password text) SET search_path = public, extensions;
ALTER FUNCTION public.scan_ticket(scanned_id text, scanned_code text) SET search_path = public, extensions;
ALTER FUNCTION public.send_email_mailersend(message jsonb, subs jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.set_last_fetch_time(p_bank_account_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.setup_external_source_dblink(p_source_name text, p_host text, p_user text, p_password text, p_port integer, p_db text, p_cron_schedule text) SET search_path = public, extensions;
ALTER FUNCTION public.setup_test_permissions(p_uid uuid) SET search_path = public, extensions;
ALTER FUNCTION public.shift_event_times_by_occasion(p_occasion_id bigint, p_hours_to_shift integer) SET search_path = public, extensions;
ALTER FUNCTION public.shift_occasion_schedule_backward(p_occasion_id bigint, p_hours_to_subtract integer) SET search_path = public, extensions;
ALTER FUNCTION public.sign_user_out_of_event(ev bigint, usr uuid) SET search_path = public, extensions;
ALTER FUNCTION public.sign_user_to_event(ev bigint, usr uuid) SET search_path = public, extensions;
ALTER FUNCTION public.storno_ticket(ticket_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.swap_spot_tickets(spot_id_1 bigint, spot_id_2 bigint) SET search_path = public, extensions;
ALTER FUNCTION public.sync_source_via_dblink(p_target_source_name text) SET search_path = public, extensions;
ALTER FUNCTION public.synchronize_my_schedule(p_event_ids bigint[], p_join_mode boolean) SET search_path = public, extensions;
ALTER FUNCTION public.update_bank_account(p_id bigint, p_account_number text, p_title text, p_type text, p_supported_currencies text[]) SET search_path = public, extensions;
ALTER FUNCTION public.update_bank_account(p_id bigint, p_account_number text, p_title text, p_type text, p_supported_currencies text[], p_account_number_human_readable text, p_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_bank_account_user(p_bank_account_id bigint, p_user_email text, p_is_admin boolean, p_is_support boolean) SET search_path = public, extensions;
ALTER FUNCTION public.update_blueprint(input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_entity_email_banner(p_entity_type text, p_entity_id bigint, p_banner_url text) SET search_path = public, extensions;
ALTER FUNCTION public.update_form(input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_inclusion_type_group(p_inclusion_type_group_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_occasion(input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_occasion_182(input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_occasion_203(input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_paid(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_sent(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_sent(order_id bigint, ticket_ids bigint[]) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_storno(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_storno_ws_221(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_data_to_sent(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_note_hidden(order_id bigint, new_note_hidden text) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_responses(p_order_id bigint, responses jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_product(p_input jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_scan_code(occasion_link text, new_scan_code text) SET search_path = public, extensions;
ALTER FUNCTION public.update_spot_assignments(p_changes jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_ticket_note_hidden(ticket_id bigint, new_note_hidden text) SET search_path = public, extensions;
ALTER FUNCTION public.update_ticket_products_ws(p_ticket_id bigint, p_product_ids bigint[]) SET search_path = public, extensions;
ALTER FUNCTION public.update_ticket_products_wsv2(p_ticket_id bigint, p_products jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_ticket_to_used(ticket_id bigint, scan_code text) SET search_path = public, extensions;
ALTER FUNCTION public.update_ticket_to_used_ws(ticket_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_unit(p_unit_id bigint, p_title text, p_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_updated_at_column() SET search_path = public, extensions;
ALTER FUNCTION public.update_user(input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_user(usr uuid, oc bigint, data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.upsert_event_user(event_id integer, user_id uuid) SET search_path = public, extensions;
ALTER FUNCTION public.validate_product_type(product_id bigint, required_type text) SET search_path = public, extensions;

-- Batch 2
ALTER FUNCTION public.get_ticket_details_for_generating(ticket_id_input bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_unit_edit_data(p_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.reset_password_via_scan(ticket_id bigint, password text, scan_code text) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_sent_ws(order_id bigint, ticket_ids bigint[]) SET search_path = public, extensions;
ALTER FUNCTION eshop.analyze_new_order_spots(p_spot_ids bigint[]) SET search_path = eshop, public, extensions;
ALTER FUNCTION eshop._generate_ticket_product_json(product_id_in bigint, spot_id_in bigint) SET search_path = eshop, public, extensions;
ALTER FUNCTION public.game_update_settings(oc bigint, new_start_time timestamp with time zone, new_end_time timestamp with time zone) SET search_path = public, extensions;
ALTER FUNCTION public.storno_ticket_221(ticket_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_storno_221(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION eshop.swap_spots_generate_product_json(p_product_id bigint, p_spot_id bigint) SET search_path = eshop, public, extensions;
ALTER FUNCTION public.update_occasion_email_banner(p_occasion_id bigint, p_banner_url text) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_editor_view_on_unit(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION eshop._swap_spots_update_ticket(p_opt_id bigint, p_new_product_id bigint, p_new_spot_id bigint) SET search_path = eshop, public, extensions;
ALTER FUNCTION public.get_all_form_fields(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.delete_product(p_product_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.apply_planned_changes() SET search_path = public, extensions;
ALTER FUNCTION public.get_order_history(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public._swap_spots_update_ticket(p_opt_id bigint, p_new_product_id bigint, p_new_spot_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_form(form_key uuid) SET search_path = public, extensions;
ALTER FUNCTION public.get_products_for_ticket(ticket_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_scan_code(occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_editor_view_via_form_link(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.update_inventory_pool_bundle(p_bundle_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.delete_service_item(oc bigint, type text, code text, force boolean) SET search_path = public, extensions;
ALTER FUNCTION public.update_service_item(oc bigint, type text, code text, new_title text, new_reference bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_occasion_user(usr uuid, oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_occasion_user_email(p_occasion bigint, p_user uuid) SET search_path = public, extensions;
ALTER FUNCTION public.get_user_info_for_users(user_ids uuid[], oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_order(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.analyze_new_order_spots(p_spot_ids bigint[]) SET search_path = public, extensions;
ALTER FUNCTION public.delete_entity_email_template(p_entity_type text, p_entity_id bigint, p_code text) SET search_path = public, extensions;
ALTER FUNCTION public.delete_user(usr uuid, oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_editor_order_view_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.generate_schema_policies_ddl(p_schema text) SET search_path = public, extensions;
ALTER FUNCTION public.generate_ticket_symbol(organization_id bigint, occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.storno_tickets_bulk(p_ticket_ids bigint[]) SET search_path = public, extensions;
ALTER FUNCTION public.generate_payment_variable_symbol(p_bank_account_id bigint, p_form_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.generate_schema_ddl(p_schema text) SET search_path = public, extensions;
ALTER FUNCTION public.delete_unit(p_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.internal_storno_tickets_221(ticket_ids_to_storno bigint[]) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_tickets_for_scan(scan_code text) SET search_path = public, extensions;
ALTER FUNCTION public.generate_triggers_ddl() SET search_path = public, extensions;
ALTER FUNCTION public.get_form_by_link(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_events_for_datagrid(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.create_user_from_registration(org bigint, email text, password text, data jsonb, unit_title text) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_admin_on_organization(org bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_entity_email_templates(p_entity_type text, p_entity_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_blueprint(my_secret uuid, form_key uuid, blueprint_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_transactions_for_order(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_fetchable_bank_accounts_with_days(p_days integer) SET search_path = public, extensions;
ALTER FUNCTION public.get_available_occasions(p_organization_id bigint, p_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.add_image_record(p_link text, p_occasion_id bigint, p_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_occasion_users_for_editor(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_products_and_types_for_edit(occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_report_for_occasion(occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_unit_for_edit(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.stop_external_source_sync(p_source_name text) SET search_path = public, extensions;
ALTER FUNCTION public.migrate_users_to_org(organization bigint) SET search_path = public, extensions;
ALTER FUNCTION public.queue_payment_reminders(p_occasion_id bigint, p_seconds_before_deadline bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_editor_on_unit(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_editor_order_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.recalculate_order_payment_status(p_order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_form_for_edit(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.update_activities(p_occasion_id bigint, p_activities_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_public_occasions(p_organization_id bigint, p_unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_paid_ws(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_bank_name_from_code(p_code text) SET search_path = public, extensions;
ALTER FUNCTION eshop.fetch_and_insert_transactions() SET search_path = eshop, public, extensions;
ALTER FUNCTION public.update_bank_account_token(p_bank_account_id bigint, p_token text, p_valid_until timestamp with time zone) SET search_path = public, extensions;
ALTER FUNCTION public.add_transaction_to_payment_info_ws(p_transaction_id bigint, p_payment_info_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_editor_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_editor_for_bank_account(bank_acc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_editor_order_view_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_editor_view_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_editor_order_view_via_form_link(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.check_occasion_link(link_txt text) SET search_path = public, extensions;
ALTER FUNCTION public.check_is_manager_on_unit(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.check_occasion_status_and_get_exists(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.create_companion(oc bigint, usr uuid, c_name text) SET search_path = public, extensions;
ALTER FUNCTION public.check_request_secret(p_secret text) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_manager_on_unit(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_last_sign_in_at(user_id uuid) SET search_path = public, extensions;
ALTER FUNCTION public.create_user_in_organization_with_data(org bigint, email text, password text, data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.game_get_correctly_guessed_checkpoints(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_service_items(oc bigint, type text) SET search_path = public, extensions;
ALTER FUNCTION public.get_available_platforms(organization_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.delete_occasion_user_ws(usr_to_delete uuid, occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_app_config_v183(data_in jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_app_config_v2(data_in jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.extract_history_product_ids(history_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.extract_history_products_with_price(history_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.fetch_and_insert_transactions() SET search_path = public, extensions;
ALTER FUNCTION public.game_get_correctly_guessed_checkpoints() SET search_path = public, extensions;
ALTER FUNCTION public.get_bank_account_secret(p_bank_account_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_email_templates_via_occasion_link(occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_forms(occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_occasions_for_edit_v182(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_occasions_for_edit_v183(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_user_basics_from_unit(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_user_basics_from_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_all_user_groups(p_occasion_id bigint, p_type text) SET search_path = public, extensions;
ALTER FUNCTION public.get_blueprint_editor(blueprint_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_blueprint_editor(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_blueprint_editor(form_key uuid) SET search_path = public, extensions;
ALTER FUNCTION public.get_current_quote(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_due_queue_emails() SET search_path = public, extensions;
ALTER FUNCTION public.get_events(p_occasion bigint, p_include_description boolean) SET search_path = public, extensions;
ALTER FUNCTION public.get_inclusion_type_groups_by_link(p_occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_form_from_link(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_forms_by_link(occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_inventory_pools_by_occasion_link(p_occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_editor_view_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_editor_on_any_occasion() SET search_path = public, extensions;
ALTER FUNCTION public.get_is_editor_on_occasion(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_is_editor_on_unit(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_latest_order_history(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_my_claim(claim text) SET search_path = public, extensions;
ALTER FUNCTION public.get_my_claims() SET search_path = public, extensions;
ALTER FUNCTION public.get_last_sign_in_at_for_users(user_ids uuid[], oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_news_with_views(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_transactions_for_order_with_same_bank_account_and_null_paym(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_occasion_users_for_edit(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.import_users_from_tickets(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_order_details(orderid bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_order_occasion(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_orders_for_ticket_sending() SET search_path = public, extensions;
ALTER FUNCTION public.get_products_for_ticket_all_available(ticket_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_report_for_occasion_with_security(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_report_for_occasion_ws(form_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_report_for_occasiont(occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_report_ws(occasion_link text) SET search_path = public, extensions;
ALTER FUNCTION public.get_resources_for_inventory_pool(p_inventory_pool_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_ticket(scanned_id text) SET search_path = public, extensions;
ALTER FUNCTION public.get_tickets_by_order(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_unit(unit_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_user_basics_from_occasion_unit(oc bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_user_group_info(p_group_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.groups_get_user_groups() SET search_path = public, extensions;
ALTER FUNCTION public.set_user_password_token(token uuid, password text) SET search_path = public, extensions;
ALTER FUNCTION public.list_activity_history(p_occasion_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.mark_payment_reminder_sent(p_payment_info_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.migrate_user_emails(organization bigint) SET search_path = public, extensions;
ALTER FUNCTION public.process_token_register(data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.revert_user_emails(organization bigint) SET search_path = public, extensions;
ALTER FUNCTION public.save_activity_history(p_occasion_id bigint, p_activities_data jsonb, p_history_type text, p_note text) SET search_path = public, extensions;
ALTER FUNCTION public.save_activity_history(p_occasion_id bigint, p_activities_data jsonb, p_history_type text, p_max_age_interval text, p_note text) SET search_path = public, extensions;
ALTER FUNCTION public.save_activity_history(p_occasion_id bigint, p_activities_data jsonb, p_history_type text, p_parent_history_id bigint, p_note text) SET search_path = public, extensions;
ALTER FUNCTION public.select_spot(form_key uuid, secret_id uuid, spot_id bigint, selecting boolean) SET search_path = public, extensions;
ALTER FUNCTION public.seed_org_with_admin(admin_email text, admin_password text) SET search_path = public, extensions;
ALTER FUNCTION public.set_user_password(user_email text, password text) SET search_path = public, extensions;
ALTER FUNCTION public.set_payment_deadline(p_payment_info_id bigint, p_new_deadline timestamp with time zone) SET search_path = public, extensions;
ALTER FUNCTION public.set_user_password(usr uuid, oc bigint, password text) SET search_path = public, extensions;
ALTER FUNCTION public.setup_crons(p_project_url text) SET search_path = public, extensions;
ALTER FUNCTION public.setup_triggers(p_project_url text) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_storno_ws(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_email_template(p_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_occasion_user(input_data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_paid_with_security(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_order_and_tickets_to_storno_with_security(order_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.validate_item_type(item_id bigint, required_type text) SET search_path = public, extensions;
ALTER FUNCTION public.update_payment_info_variable_symbol(p_payment_info_id bigint, p_variable_symbol bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_resource(p_input jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_product_inventory_contexts(p_product_id bigint, p_contexts jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.update_unit_user(input_data jsonb) SET search_path = public, extensions;

-- Final Batch
ALTER FUNCTION public.get_bank_account_by_pairing_code(p_code text) SET search_path = public, extensions;
ALTER FUNCTION public.log_transactions_parser_log(p_bank_account_id bigint, p_external_id text, p_raw_data text, p_message text) SET search_path = public, extensions;
ALTER FUNCTION public.insert_manual_transaction(p_amount double precision, p_currency text, p_unit_id integer, p_variable_symbol text, p_date text, p_note text, p_payment_info_id integer) SET search_path = public, extensions;
ALTER FUNCTION public.get_my_admin_organization_id() SET search_path = public, extensions;
ALTER FUNCTION public.check_is_admin_of_organization(organization_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.get_organization_admin(organization_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.update_organization_admin(organization_id bigint, title text, data jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_app_config_v217(data_in jsonb) SET search_path = public, extensions;
ALTER FUNCTION public.get_occasion_seo_data(p_link_slug text) SET search_path = public, extensions;
ALTER FUNCTION public.get_or_create_bank_import_token(p_account_id bigint) SET search_path = public, extensions;
ALTER FUNCTION public.link_bank_account_to_unit(p_bank_account_id bigint, p_unit_id bigint, p_priority integer, p_hard boolean) SET search_path = public, extensions;
ALTER FUNCTION public.delete_claim(uid uuid, claim text) SET search_path = public, extensions;
ALTER FUNCTION public.get_claim(uid uuid, claim text) SET search_path = public, extensions;
ALTER FUNCTION public.get_claims(uid uuid) SET search_path = public, extensions;
ALTER FUNCTION public.set_claim(uid uuid, claim text, value jsonb) SET search_path = public, extensions;
ALTER FUNCTION eshop.get_bank_account_by_pairing_code(p_code text) SET search_path = eshop, public, extensions;
