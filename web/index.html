<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Application for events.">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Absolventský Velehrad">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Absolventský Velehrad" />
  <link rel="manifest" href="site.webmanifest" />
  <meta name="theme-color" content="#ffffff">

  <title>Absolventský Velehrad</title>
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];

   async function initializeOneSignal(callback, errorCallback) {
       if (!window.OneSignalInitialized) {
           window.OneSignalInitialized = true;
           OneSignalDeferred.push(async function(OneSignal) {
               try {
                 await OneSignal.init({
                       appId: "7837e2c3-6e5e-463c-9672-4db6c55888da",
                       safari_web_id: "web.onesignal.auto.10485988-1822-4e96-b399-29edb7cde282",
                       allowLocalhostAsSecureOrigin: true,
                       persistNotification: false,
                       welcomeNotification: {
                         title: "Notifikace",
                         message: "Děkujeme za povolení notifikací.",
                       },
                       serviceWorkerParam: { scope: "/push/" },
                       serviceWorkerPath: "./push/OneSignalSDKWorker.js",
                   });

                   OneSignal.Notifications.addEventListener('foregroundWillDisplay', function(event) {
                       console.log("Received notification: ", event.notification.title, event.notification.body);
                       // Show SnackBar or do async work
                   });
               } catch (error) {
                 console.log("OneSignal initialization failed:", error);
               }

               if (callback) callback(null);
           });
       }
   }

   async function requestNotificationPermission(callback, errorCallback) {
       try {
           await OneSignal.Notifications.requestPermission()
           console.log("Notification permission request sent.");
           if (callback) callback(getNotificationPermission());
       } catch (error) {
           console.error("Notification permission request failed:", error);
           if (errorCallback) errorCallback(error);
       }
   }

   async function logout(callback, errorCallback) {
       OneSignalDeferred.push(async function(OneSignal) {
           await OneSignal.logout();
           console.log("User has been logged out from OneSignal.");
       });
       if (callback) callback(null);
   }

   async function login(externalId, callback, errorCallback) {
       console.log("User is logging to OneSignal with Id:", externalId);
       OneSignalDeferred.push(async function(OneSignal) {
           await OneSignal.login(externalId);
           console.log("User has been logged in to OneSignal successfully with externalId:", externalId);
       });
       if (callback) callback(null);
   }

   function getNotificationPermission() {
    // Check if the Notification API is supported
    if (!("Notification" in window)) {
      console.error("This browser does not support desktop notifications.");
      return false;
    }

    // Check if the site is served over HTTPS or is running on localhost
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
      console.error("Notifications require a secure context (HTTPS).");
      return false;
    }

    // Return the permission status
    return OneSignal.Notifications.permission;
  }

   async function optIn(callback, errorCallback) {
       try {
           await OneSignal.User.PushSubscription.optIn();
           console.log("User has opted in for notifications.");
       } catch (error) {
           console.error("Opt-in for notifications failed:", error);
       }
       if (callback) callback(null);
   }

   async function optOut(callback, errorCallback) {
       try {
           await OneSignal.User.PushSubscription.optOut();
           console.log("User has opted out of notifications.");
       } catch (error) {
           console.error("Opt-out of notifications failed:", error);
       }
       if (callback) callback(null);
   }
  </script>
  <script>
    function setMetaThemeColor(color) {
        document.querySelector('meta[name="theme-color"]').setAttribute("content", color);
      }
    function setBodyBackgroundColor(color) {
      document.body.style.backgroundColor = color;
    }
  </script>
</head>
<body>

<script>
  // Disable swipe back gesture globally
  document.body.style.overscrollBehaviorX = "none";
  document.body.style.overscrollBehaviorY = "none";

  let deferredPrompt;

  window.addEventListener('beforeinstallprompt', (e) => {
    deferredPrompt = e;
    e.preventDefault();
    return false;
  });

  function promptInstall(){
     deferredPrompt.prompt();
  }

  // Listen for app install event
  window.addEventListener('appinstalled', () => {
    deferredPrompt = null;
    appInstalled();
  });

  // Track how PWA was launched (either from browser or as PWA)
  function getLaunchMode() {
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    if(deferredPrompt) hasPrompt();
    if (document.referrer.startsWith('android-app://')) {
      appLaunchedAsTWA();
    } else if (navigator.standalone || isStandalone) {
      appLaunchedAsPWA();
    } else {
      window.appLaunchedInBrowser();
    }
  }
</script>

<script>
  window.addEventListener('load', function(ev) {
      {{flutter_js}}
      {{flutter_build_config}}

      _flutter.loader.load({
        onEntrypointLoaded: async function(engineInitializer) {
          const appRunner = await engineInitializer.initializeEngine({
            useColorEmoji: true
          });
          await appRunner.runApp();
        }
      });
    });
</script>

<style>
  body {
  background-color: white;
  height: 100vh;
  width: 100vw;
  margin: 0px;
}
.main-content {
  height: 100%;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.4s ease-out;
}

svg {
margin-top: -72px;
margin-left: -36px;
max-width: 280px;
max-height: 100px;
position: absolute;
}
</style>

<div class="main-content" id="loader-content">
  <div class="loader">
      <span>
        <svg width="72" height="72" viewBox="0 0 227 227" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M52.14 126.535L35.6078 126.536C32.0966 126.536 29.2493 123.689 29.2493 120.177V6.35915C29.2493 2.84733 32.0966 0.000610352 35.6078 0.000610352H118.269C121.781 0.000610352 124.627 2.84733 124.627 6.35915V22.8856H101.737V53.4067H75.0181V76.2974H101.737V103.644H52.14V126.535Z" fill="#2C677B"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M52.1401 126.535V197.751C52.1401 201.26 54.9894 204.109 58.4987 204.109L101.737 204.104V126.535H52.1401Z" fill="#E0B73B"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M174.224 126.53H190.768C194.277 126.53 197.126 123.681 197.126 120.171V29.2442C197.126 25.7349 194.277 22.8856 190.768 22.8856H124.627V53.4066H151.321V76.2974H124.627V103.644H174.224V126.53Z" fill="#BA5D3F"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M101.737 204.104V220.641C101.737 224.151 104.586 227 108.095 227H167.865C171.375 227 174.224 224.151 174.224 220.641V126.535H124.627V204.104H101.737Z" fill="#2A77A0"/>
          </svg>
      </span>
  </div>
</div>
</body>
</html>
